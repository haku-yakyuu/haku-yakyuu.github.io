---
const { product, solidTagsList } = Astro.props;

// 1. Layout 處理
const layout = product.layout || 'vertical'; 
let cardClass = 'haku-card';
if (layout === 'horizontal') cardClass += ' horizontal';
if (layout === 'no_image') cardClass += ' horizontal no-image';

// 2. 圖片路徑智慧處理
let imageUrl = null;
if (product.images.length > 0) {
    const rawImg = product.images[0];
    // 如果是 http 開頭，保持原樣；否則視為本地路徑 (public/)
    if (rawImg.startsWith('http')) {
        imageUrl = rawImg;
    } else {
        // 確保路徑以 / 開頭
        imageUrl = rawImg.startsWith('/') ? rawImg : '/' + rawImg;
    }
}

// 3. 狀態與圖示
const isSoldOut = product.stock === 0;
const actionIcon = (layout === 'no_image' || isSoldOut) ? 'arrow_forward' : 'add_shopping_cart';
// 只有購物車圖示才需要觸發側邊欄
const iconClass = (actionIcon === 'add_shopping_cart') ? 'material-symbols-outlined cart-icon cart-trigger' : 'material-symbols-outlined cart-icon';

const displayPrice = product.price > 0 ? `$ ${product.price.toLocaleString()}` : 'Free';
---

<div class={`${cardClass} ${isSoldOut ? 'sold-out' : ''}`}>
    
    {layout === 'vertical' && (
        <div class="img-v">
            {imageUrl ? (
                <img src={imageUrl} alt={product.name} loading="lazy" />
            ) : (
                <span class="material-symbols-outlined" style="font-size:48px;">collections</span>
            )}
            {isSoldOut && <div class="sold-out-overlay">SOLD OUT</div>}
        </div>
    )}

    {layout === 'horizontal' && (
        <div class="h-card-img">
            {imageUrl ? (
                <img src={imageUrl} alt={product.name} loading="lazy" />
            ) : (
                <span class="material-symbols-outlined">image</span>
            )}
            {isSoldOut && <div class="sold-out-overlay sm">SOLD</div>}
        </div>
    )}

    <div class="card-body">
        <div class="tag-group">
            {product.tags.map(tag => {
                const isSolid = solidTagsList.includes(tag);
                return <span class={`tag ${isSolid ? 'tag-solid' : 'tag-hollow'}`}>{tag}</span>
            })}
        </div>
        <h3 class="p-name">{product.name}</h3>
        <div class="p-price">{displayPrice}</div>
        
        <!-- 點擊此圖示會觸發 Layout 中的 JS 打開側邊欄 -->
        <span class={iconClass}>{actionIcon}</span>
    </div>
</div>

<style>
    .haku-card { 
        background-color: var(--haku-paper); 
        border: 1px solid rgba(62, 39, 35, 0.1); 
        display: flex; flex-direction: column; 
        position: relative; overflow: hidden; 
        transition: transform 0.2s;
    }
    .haku-card:hover { transform: translateY(-4px); box-shadow: 0 10px 20px rgba(62,39,35,0.08); }

    .card-body { padding: 18px; flex-grow: 1; display: flex; flex-direction: column; position: relative; }
    
    .p-name { font-size: 1rem; font-weight: 700; margin: 0 0 12px 0; padding-right: 30px; color: var(--haku-ink); line-height: 1.4; }
    .p-price { font-family: 'Montserrat', sans-serif; font-weight: 900; font-size: 1.1rem; margin-top: auto; color: var(--haku-ink); }
    .cart-icon { position: absolute; bottom: 18px; right: 18px; cursor: pointer; color: var(--haku-ink); opacity: 0.8; }
    .cart-icon:hover { opacity: 1; transform: scale(1.1); }

    .tag-group { display: flex; flex-wrap: wrap; gap: 6px; margin-bottom: 12px; }
    .tag { font-size: 0.65rem; font-weight: 700; padding: 2px 8px; border: 1px solid var(--haku-ink); border-radius: 2px; text-transform: uppercase; }
    .tag-hollow { color: var(--haku-ink); background: transparent; }
    .tag-solid { color: var(--haku-paper); background: var(--haku-ink); }

    .img-v { 
        position: relative; width: 100%; aspect-ratio: 1/1; 
        background: var(--placeholder-bg); color: var(--placeholder-icon);
        display: flex; justify-content: center; align-items: center; 
    }
    .h-card-img { 
        width: 120px; flex-shrink: 0; position: relative;
        background: var(--placeholder-bg); color: var(--placeholder-icon);
        display: flex; justify-content: center; align-items: center; 
    }
    img { width: 100%; height: 100%; object-fit: cover; display: block; }

    .haku-card.horizontal { flex-direction: row; min-height: 130px; }
    .horizontal .card-body { justify-content: center; }
    
    .no-image { border-top: 5px solid var(--haku-ink); }
    .no-image .card-body { padding: 25px 18px; }

    .sold-out { opacity: 0.8; pointer-events: none; }
    .sold-out-overlay {
        position: absolute; top:0; left:0; width:100%; height:100%;
        background: rgba(62,39,35,0.7); color: #FFF;
        display: flex; justify-content: center; align-items: center;
        font-family: 'Montserrat'; font-weight: 900;
    }
    .sold-out-overlay.sm { font-size: 0.8rem; }
</style>
