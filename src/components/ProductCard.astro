---
// src/components/ProductCard.astro
interface Props {
  product: {
    id: string;
    name: string;
    price: number;
    stock: number;
    category: string;
    isFeatured: boolean;
    tags: string;
    status: string;
    images: string; // 商品圖片 (逗號分隔)
    layout: 'vertical' | 'horizontal' | 'no_image'; // 樣式
    desc: string;
  };
  config: {
    solid_tags: string;
  };
}

const { product, config } = Astro.props;

// 1. 處理佈局預設邏輯
// 如果 layout 為空或 images 為空，則強制使用 no_image
const imagesArr = product.images ? product.images.split(',').map(url => url.trim()).filter(url => url !== "") : [];
const activeLayout = (product.layout && imagesArr.length > 0) ? product.layout : 'no_image';

// 2. 格式化標籤
const solidTagsArr = config.solid_tags ? config.solid_tags.split(',').map(t => t.trim()) : [];
const tagsArr = product.tags ? product.tags.split(',').map(t => t.trim()) : [];

// 3. 格式化價格
const formattedPrice = new Intl.NumberFormat('zh-TW', {
  style: 'currency',
  currency: 'TWD',
  maximumFractionDigits: 0
}).format(product.price);
---

<div class={`haku-card ${activeLayout === 'horizontal' ? 'horizontal' : ''} ${activeLayout === 'no_image' ? 'no-image' : ''}`} data-id={product.id}>
  
  {/* 圖片區域 */}
  {activeLayout !== 'no_image' && (
    <div class={`img-box ${activeLayout === 'vertical' ? 'img-v js-carousel' : 'img-h'}`}>
      {activeLayout === 'vertical' && imagesArr.length > 1 ? (
        <div class="carousel-wrap">
          <div class="carousel-track">
            {imagesArr.map(url => <img src={url} alt={product.name} loading="lazy" />)}
          </div>
          <button class="carousel-btn btn-prev material-symbols-outlined">chevron_left</button>
          <button class="carousel-btn btn-next material-symbols-outlined">chevron_right</button>
          <div class="carousel-dots">
            {imagesArr.map((_, i) => <div class={`dot ${i === 0 ? 'active' : ''}`}></div>)}
          </div>
        </div>
      ) : (
        <img src={imagesArr[0]} alt={product.name} loading="lazy" />
      )}
    </div>
  )}

  {/* 文字內容區域 */}
  <div class="card-body">
    <div class="tag-group">
      {tagsArr.map(tag => (
        <span class={`tag ${solidTagsArr.includes(tag) ? 'tag-solid' : 'tag-hollow'}`}>{tag}</span>
      ))}
    </div>
    <h3 class="p-name">{product.name}</h3>
    <div class="p-price">{formattedPrice}</div>
    
    {/* 圖示切換：無圖顯示箭頭，其餘顯示購物車 */}
    <span class="material-symbols-outlined cart-icon">
      {activeLayout === 'no_image' ? 'arrow_forward' : 'add_shopping_cart'}
    </span>
  </div>
</div>

<style>
  :root {
    --haku-ink: #3E2723;
    --haku-paper: #F5F1E8;
    --placeholder-bg: #DCD7CE;
  }

  .haku-card {
    background-color: var(--haku-paper);
    border: 1px solid rgba(62, 39, 35, 0.1);
    display: flex;
    flex-direction: column;
    position: relative;
    overflow: hidden;
    height: 100%;
    transition: transform 0.3s ease;
  }
  .haku-card:hover { transform: translateY(-5px); }

  .card-body { padding: 18px; flex-grow: 1; display: flex; flex-direction: column; position: relative; }
  
  .p-name { 
    font-size: 1rem; font-weight: 700; margin: 0 0 12px 0; line-height: 1.4;
    display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; width: 100%;
  }

  .p-price { font-family: 'Montserrat', sans-serif; font-weight: 900; font-size: 1.1rem; margin-top: auto; }
  .cart-icon { position: absolute; bottom: 18px; right: 18px; opacity: 0.8; cursor: pointer; z-index: 10; }

  /* 標籤 */
  .tag-group { display: flex; flex-wrap: wrap; gap: 6px; margin-bottom: 12px; }
  .tag { font-size: 0.65rem; font-weight: 700; padding: 2px 8px; border: 1px solid var(--haku-ink); border-radius: 2px; text-transform: uppercase; }
  .tag-hollow { color: var(--haku-ink); background: transparent; }
  .tag-solid { color: var(--haku-paper); background: var(--haku-ink); }

  /* 圖片與輪播 */
  .img-box { background: var(--placeholder-bg); overflow: hidden; position: relative; }
  .img-v { aspect-ratio: 1/1; width: 100%; }
  .img-h { width: 110px; height: 100%; flex-shrink: 0; }
  .img-box img { width: 100%; height: 100%; object-fit: cover; }

  .carousel-wrap { width: 100%; height: 100%; position: relative; }
  .carousel-track { display: flex; width: 100%; height: 100%; overflow-x: auto; scroll-snap-type: x mandatory; scrollbar-width: none; cursor: grab; }
  .carousel-track::-webkit-scrollbar { display: none; }
  .carousel-track img { flex: 0 0 100%; scroll-snap-align: start; }

  .carousel-btn { position: absolute; top: 50%; transform: translateY(-50%); background: rgba(255,255,255,0.9); border: none; border-radius: 50%; width: 36px; height: 36px; display: flex; align-items: center; justify-content: center; cursor: pointer; z-index: 5; opacity: 0; transition: 0.3s; }
  .btn-prev { left: 10px; }
  .btn-next { right: 10px; }
  @media (min-width: 1024px) { .haku-card:hover .carousel-btn { opacity: 1; } }

  .carousel-dots { position: absolute; bottom: 12px; left: 50%; transform: translateX(-50%); display: flex; gap: 5px; z-index: 5; }
  .dot { width: 5px; height: 5px; border-radius: 50%; background: rgba(255,255,255,0.4); }
  .dot.active { background: #FFF; width: 12px; border-radius: 3px; }

  /* 橫式與無圖樣式 */
  .haku-card.horizontal { flex-direction: row; min-height: 130px; }
  .no-image { border-top: 5px solid var(--haku-ink); }
</style>

<script>
  function initCarousels() {
    document.querySelectorAll('.js-carousel').forEach(carousel => {
      const track = carousel.querySelector('.carousel-track') as HTMLElement;
      const nextBtn = carousel.querySelector('.btn-next');
      const prevBtn = carousel.querySelector('.btn-prev');
      const dots = carousel.querySelectorAll('.dot');
      if(!track || !nextBtn || !prevBtn) return;
      
      const total = track.querySelectorAll('img').length;

      const updateUI = () => {
        const index = Math.round(track.scrollLeft / track.offsetWidth);
        dots.forEach((d, i) => d.classList.toggle('active', i === index));
      };

      nextBtn.addEventListener('click', (e) => {
        e.preventDefault();
        const cur = Math.round(track.scrollLeft / track.offsetWidth);
        track.scrollTo({ left: cur >= total - 1 ? 0 : track.scrollLeft + track.offsetWidth, behavior: 'smooth' });
      });

      prevBtn.addEventListener('click', (e) => {
        e.preventDefault();
        const cur = Math.round(track.scrollLeft / track.offsetWidth);
        track.scrollTo({ left: cur <= 0 ? track.offsetWidth * (total - 1) : track.scrollLeft - track.offsetWidth, behavior: 'smooth' });
      });

      track.addEventListener('scroll', updateUI);
    });
  }

  // 支援 Astro 視圖過渡與初始載入
  initCarousels();
  document.addEventListener('astro:page-load', initCarousels);
</script>
