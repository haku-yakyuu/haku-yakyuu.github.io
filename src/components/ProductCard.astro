---
// 接收參數
const { product, solidTagsList = [] } = Astro.props;

// --- 1. 資料防護與標準化 ---
const safeProduct = product || {};
const name = safeProduct.name || '未命名商品';
const price = safeProduct.price || 0;
const tags = Array.isArray(safeProduct.tags) ? safeProduct.tags : [];
const stock = safeProduct.stock !== undefined ? safeProduct.stock : 1;
const rawLayout = safeProduct.layout || 'vertical';

// --- 2. 圖片路徑處理 (智慧修復版) ---
const resolveImgPath = (src) => {
    if (!src || typeof src !== 'string') return '';
    const trimmedSrc = src.trim();

    // A. 外部連結直接回傳
    if (trimmedSrc.startsWith('http') || trimmedSrc.startsWith('data:')) return trimmedSrc;

    // B. 本地路徑處理
    let cleanPath = trimmedSrc;
    if (cleanPath.startsWith('./')) cleanPath = cleanPath.slice(2);
    if (cleanPath.startsWith('public/')) cleanPath = cleanPath.slice(7); // 修正常見路徑錯誤
    if (cleanPath.startsWith('/')) cleanPath = cleanPath.slice(1);

    const baseUrl = import.meta.env.BASE_URL;
    const cleanBase = baseUrl.endsWith('/') ? baseUrl : `${baseUrl}/`;

    return `${cleanBase}${cleanPath}`;
};

// 處理圖片陣列 (關鍵修正：過濾髒資料)
const rawImages = Array.isArray(safeProduct.images) ? safeProduct.images : [];
const images = rawImages
    .filter(img => typeof img === 'string' && img.trim() !== '')
    // *** 這裡解決 404 問題：踢除誤入的排版關鍵字 ***
    .filter(img => !['vertical', 'horizontal', 'no_image'].includes(img.trim()))
    .map(img => resolveImgPath(img));

// --- 3. 版型判斷 ---
const isSoldOut = stock === 0;
// 如果過濾後沒有有效圖片，自動切換為無圖模式
const layout = (images.length === 0) ? 'no_image' : rawLayout;

let cardClass = 'haku-card';
if (layout === 'horizontal') cardClass += ' horizontal';
if (layout === 'no_image') cardClass += ' horizontal no-image';

// Icon 邏輯
const actionIcon = (layout === 'no_image' || isSoldOut) ? 'arrow_forward' : 'add_shopping_cart';
const iconClass = (actionIcon === 'add_shopping_cart') ? 'material-symbols-outlined cart-icon cart-trigger' : 'material-symbols-outlined cart-icon';
const displayPrice = price > 0 ? `$ ${price.toLocaleString()}` : 'Free';

// Slider 邏輯
const showSlider = images.length > 1 && layout === 'vertical';
const uniqueID = `slider-${safeProduct.id || Math.random().toString(36).substr(2, 9)}`;
---

<div class={`${cardClass} ${isSoldOut ? 'sold-out' : ''}`} id={uniqueID}>
    
    {/* --- 圖片區域 --- */}
    {layout !== 'no_image' && (
        <div class={layout === 'vertical' ? 'img-v' : 'img-h'}>
            
            {/* 1. 底層預設圖示 (Fallback) */}
            <span class="material-symbols-outlined fallback-icon">
                {layout === 'vertical' ? 'collections' : 'image'}
            </span>

            {/* 2. 圖片容器 */}
            {images.length > 0 && (
                <div class={`slider-track ${showSlider ? 'is-slider' : ''}`}>
                    {images.map((imgSrc, index) => (
                        <img 
                            src={imgSrc} 
                            alt={`${name} - ${index + 1}`} 
                            loading="lazy"
                            class="product-img"
                            /* 圖片載入失敗時變透明，讓底下的 fallback icon 顯露出來 */
                            onerror="this.style.opacity='0';" 
                        />
                    ))}
                </div>
            )}

            {/* 3. Slider 控制器 */}
            {showSlider && (
                <>
                    <button class="slider-btn prev" aria-label="Previous" onclick={`document.querySelector('#${uniqueID} .slider-track').scrollBy({left: -200, behavior: 'smooth'})`}>
                        <span class="material-symbols-outlined">chevron_left</span>
                    </button>
                    <button class="slider-btn next" aria-label="Next" onclick={`document.querySelector('#${uniqueID} .slider-track').scrollBy({left: 200, behavior: 'smooth'})`}>
                        <span class="material-symbols-outlined">chevron_right</span>
                    </button>
                    
                    <div class="dots">
                        {images.map((_, idx) => (
                            <div class={`dot ${idx === 0 ? 'active' : ''}`}></div>
                        ))}
                    </div>
                </>
            )}

            {isSoldOut && <div class={`sold-out-overlay ${layout === 'horizontal' ? 'sm' : ''}`}>SOLD</div>}
        </div>
    )}

    {/* --- 內容區域 --- */}
    <div class="card-body">
        <div class="tag-group">
            {tags.map(tag => {
                const isSolid = solidTagsList.includes(tag);
                return <span class={`tag ${isSolid ? 'tag-solid' : 'tag-hollow'}`}>{tag}</span>
            })}
        </div>
        
        <h3 class="p-name">{name}</h3>
        <div class="p-price">{displayPrice}</div>
        
        <span class={iconClass}>{actionIcon}</span>
    </div>
</div>

<style>
    /* --- HAKU V5 CSS --- */
    :root {
        --haku-ink: #3E2723;
        --haku-paper: #F5F1E8;
        --placeholder-bg: #DCD7CE;
        --placeholder-icon: rgba(62, 39, 35, 0.3);
    }

    .haku-card { 
        background-color: var(--haku-paper); 
        border: 1px solid rgba(62, 39, 35, 0.1); 
        display: flex; flex-direction: column; 
        position: relative; overflow: hidden; 
        transition: transform 0.2s;
        min-height: 200px; /* 確保即使資料缺少也有基本高度 */
    }
    .haku-card:hover { transform: translateY(-4px); box-shadow: 0 10px 20px rgba(62,39,35,0.08); }

    .card-body { padding: 18px; flex-grow: 1; display: flex; flex-direction: column; position: relative; }
    
    .p-name { font-size: 1rem; font-weight: 700; margin: 0 0 12px 0; padding-right: 30px; line-height: 1.4; color: var(--haku-ink); }
    .p-price { font-family: 'Montserrat', sans-serif; font-weight: 900; font-size: 1.1rem; margin-top: auto; color: var(--haku-ink); }
    
    .cart-icon { position: absolute; bottom: 18px; right: 18px; cursor: pointer; color: var(--haku-ink); opacity: 0.8; }
    .cart-icon:hover { opacity: 1; transform: scale(1.1); }

    /* Tags */
    .tag-group { display: flex; flex-wrap: wrap; gap: 6px; margin-bottom: 12px; }
    .tag { font-size: 0.65rem; font-weight: 700; padding: 2px 8px; border: 1px solid var(--haku-ink); border-radius: 2px; text-transform: uppercase; }
    .tag-hollow { color: var(--haku-ink); background: transparent; }
    .tag-solid { color: var(--haku-paper); background: var(--haku-ink); }

    /* Images */
    .img-v, .img-h { 
        position: relative; 
        background: var(--placeholder-bg); 
        color: var(--placeholder-icon);
        display: flex; justify-content: center; align-items: center; 
        overflow: hidden;
    }
    .img-v { width: 100%; aspect-ratio: 1/1; }
    .img-h { width: 120px; flex-shrink: 0; min-height: 100%; }

    .fallback-icon { font-size: 48px; position: absolute; z-index: 0; }

    /* Slider Track */
    .slider-track {
        display: flex; width: 100%; height: 100%;
        overflow-x: auto; scroll-snap-type: x mandatory;
        scrollbar-width: none; z-index: 1;
    }
    .slider-track::-webkit-scrollbar { display: none; }
    
    .product-img {
        width: 100%; height: 100%; object-fit: cover;
        flex-shrink: 0; scroll-snap-align: start;
        background: transparent;
        position: relative; z-index: 1;
        transition: opacity 0.3s;
    }

    /* Slider Controls */
    .slider-btn {
        position: absolute; top: 50%; transform: translateY(-50%);
        background: rgba(245, 241, 232, 0.9);
        border: 1px solid var(--haku-ink); border-radius: 50%;
        width: 28px; height: 28px;
        display: flex; align-items: center; justify-content: center;
        cursor: pointer; z-index: 2; opacity: 0; transition: 0.2s;
        color: var(--haku-ink);
    }
    .img-v:hover .slider-btn { opacity: 1; }
    .prev { left: 8px; }
    .next { right: 8px; }

    .dots {
        position: absolute; bottom: 10px; left: 0; width: 100%;
        display: flex; justify-content: center; gap: 4px; z-index: 2;
        pointer-events: none;
    }
    .dot { width: 5px; height: 5px; border-radius: 50%; background: rgba(62,39,35,0.3); }
    .dot.active { background: var(--haku-ink); }

    /* Layout Modifiers */
    .haku-card.horizontal { flex-direction: row; min-height: 140px; }
    .horizontal .card-body { justify-content: center; }
    
    .no-image { border-top: 5px solid var(--haku-ink); }
    .no-image .img-v, .no-image .img-h { display: none; }
    .no-image .card-body { padding: 25px 18px; }

    /* Sold Out */
    .sold-out { opacity: 0.8; pointer-events: none; }
    .sold-out-overlay {
        position: absolute; top:0; left:0; width:100%; height:100%;
        background: rgba(62,39,35,0.7); color: #FFF;
        display: flex; justify-content: center; align-items: center;
        font-family: 'Montserrat'; font-weight: 900; z-index: 3;
    }
    .sold-out-overlay.sm { font-size: 0.8rem; }
</style>
