---
interface Props {
  product: any;
  config: any;
}
const { product, config } = Astro.props;

import { getProductImagePath } from '../utils/imagePath';

const rawImages = product.layout_images || product.images || "";
const imagesCount = rawImages ? rawImages.split(",").length : 0;
const imagesArr = Array.from({ length: imagesCount }, (_, i) => getProductImagePath(`/products/${product.id}-${i}.jpg`));

const layoutType = product.layout || 'vertical'; 
const solidTagsArr = config.solid_tags ? config.solid_tags.split(',').map((t:string) => t.trim()) : [];
const tagsArr = product.tags ? product.tags.split(',').map((t:string) => t.trim()) : [];
const formattedPrice = new Intl.NumberFormat('zh-TW', { style: 'currency', currency: 'TWD', maximumFractionDigits: 0 }).format(product.price);
const cartProductData = JSON.stringify(product);

// 商品連結
const productLink = `/product/${product.id}`;
---

<div class={`haku-card ${layoutType === 'horizontal' ? 'horizontal' : ''} ${layoutType === 'no_image' ? 'no-image' : ''}`} 
     data-json={cartProductData}
     onclick={`window.location.href='${productLink}'`}
     style="cursor: pointer;"
>
  
  {/* 圖片區域 */}
  {layoutType !== 'no_image' && imagesArr.length > 0 && (
    <div class={`img-box ${layoutType === 'vertical' ? 'img-v' : 'img-h'} ${imagesArr.length > 1 ? 'js-carousel' : ''}`}>
      {imagesArr.length > 1 ? (
        <div class="carousel-wrap">
          <div class="carousel-track">
            {imagesArr.map((url: string) => <img src={url} alt={product.name} loading="lazy" />)}
          </div>
          {/* 輪播按鈕需阻止冒泡，避免觸發卡片跳轉 */}
          <button class="carousel-btn btn-prev material-symbols-outlined stop-prop">chevron_left</button>
          <button class="carousel-btn btn-next material-symbols-outlined stop-prop">chevron_right</button>
          <div class="carousel-dots">
            {imagesArr.map((_:any, i:number) => <div class={`dot ${i === 0 ? 'active' : ''}`}></div>)}
          </div>
        </div>
      ) : (
        <img src={imagesArr[0]} alt={product.name} loading="lazy" />
      )}
    </div>
  )}

  {/* 內容區域 */}
  <div class="card-body">
    <div class="tag-group">
      {tagsArr.map((tag: string) => (
        <span class={`tag ${solidTagsArr.includes(tag) ? 'tag-solid' : 'tag-hollow'}`}>{tag}</span>
      ))}
    </div>
    <h3 class="p-name">{product.name}</h3>
    <div class="p-price">{formattedPrice}</div>
    
    {/* 購物車按鈕：加上 stop-prop 類別，JS 會處理防止冒泡 */}
    <span class="material-symbols-outlined cart-icon stop-prop">add_shopping_cart</span>
  </div>
</div>

<style>
  /* 保持原有樣式，僅增加 stop-prop 處理 */
  .haku-card { background-color: var(--haku-paper); border: 1px solid rgba(62, 39, 35, 0.1); display: flex; flex-direction: column; position: relative; overflow: hidden; text-decoration: none; color: inherit; transition: transform 0.3s ease; height: 100%; }
  .haku-card:hover { transform: translateY(-5px); }
  .card-body { padding: 18px; flex-grow: 1; display: flex; flex-direction: column; position: relative; align-items: flex-start; width: 100%; box-sizing: border-box; }
  .p-name { font-size: 1rem; font-weight: 700; margin: 0 0 12px 0; padding-right: 0; line-height: 1.4; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; width: 100%; box-sizing: border-box; }
  .p-price { font-family: 'Montserrat', sans-serif; font-weight: 900; font-size: 1.1rem; margin-top: auto; width: 100%; box-sizing: border-box; }
  .cart-icon { position: absolute; bottom: 18px; right: 18px; opacity: 0.8; cursor: pointer; z-index: 10; }

  @media (max-width: 1023px) {
    .p-name { font-size: 0.9rem; margin-bottom: 8px; }
    .p-price { font-size: 1rem; }
    .cart-icon { font-size: 20px; bottom: 15px; right: 15px; }
    .card-body { padding: 15px; }
  }

  .tag-group { display: flex; flex-wrap: wrap; gap: 6px; margin-bottom: 12px; width: 100%; box-sizing: border-box; }
  .tag { font-size: 0.65rem; font-weight: 700; padding: 2px 8px; border: 1px solid var(--haku-ink); border-radius: 2px; text-transform: uppercase; }
  .tag-hollow { color: var(--haku-ink); background: transparent; }
  .tag-solid { color: var(--haku-paper); background: var(--haku-ink); }

  .img-box { background: var(--placeholder-bg); overflow: hidden; position: relative; }
  .img-v { aspect-ratio: 1/1; width: 100%; }
  .img-h { width: 110px; height: 100%; flex-shrink: 0; }
  .img-box img { width: 100%; height: 100%; object-fit: cover; }

  .carousel-wrap { width: 100%; height: 100%; position: relative; }
  .carousel-track { display: flex; width: 100%; height: 100%; overflow-x: auto; scroll-snap-type: x mandatory; scrollbar-width: none; cursor: grab; }
  .carousel-track::-webkit-scrollbar { display: none; }
  .carousel-track img { flex: 0 0 100%; scroll-snap-align: start; }
  
  .carousel-btn { position: absolute; top: 50%; transform: translateY(-50%); background: rgba(255,255,255,0.9); border: none; border-radius: 50%; width: 36px; height: 36px; display: flex; align-items: center; justify-content: center; cursor: pointer; z-index: 5; opacity: 0; transition: 0.3s; }
  .btn-prev { left: 10px; } .btn-next { right: 10px; }
  @media (min-width: 1024px) { .haku-card:hover .carousel-btn { opacity: 1; } }
  
  .carousel-dots { position: absolute; bottom: 12px; left: 50%; transform: translateX(-50%); display: flex; gap: 5px; z-index: 5; }
  .dot { width: 5px; height: 5px; border-radius: 50%; background: rgba(255,255,255,0.4); }
  .dot.active { background: #FFF; width: 12px; border-radius: 3px; }

  .haku-card.horizontal { flex-direction: row; min-height: 130px; }
  .no-image { border-top: 5px solid var(--haku-ink); }
</style>

<script>
  import { addToCart } from '../store';
  
  function initInteractive() {
    // 阻止冒泡的元素 (購物車按鈕、輪播按鈕)
    document.querySelectorAll('.stop-prop').forEach(el => {
        el.addEventListener('click', (e) => e.stopPropagation());
    });

    // 輪播初始化
    document.querySelectorAll('.js-carousel').forEach(carousel => {
      if (carousel.hasAttribute('data-init')) return;
      carousel.setAttribute('data-init', 'true');
      const track = carousel.querySelector('.carousel-track') as HTMLElement;
      const nextBtn = carousel.querySelector('.btn-next');
      const prevBtn = carousel.querySelector('.btn-prev');
      const dots = carousel.querySelectorAll('.dot');
      if(!track || !nextBtn || !prevBtn) return;
      const total = track.querySelectorAll('img').length;
      
      const updateUI = () => {
        const index = Math.round(track.scrollLeft / track.offsetWidth);
        dots.forEach((d, i) => d.classList.toggle('active', i === index));
      };
      nextBtn.addEventListener('click', (e) => { e.preventDefault(); e.stopPropagation(); const cur = Math.round(track.scrollLeft / track.offsetWidth); track.scrollTo({ left: cur >= total - 1 ? 0 : track.scrollLeft + track.offsetWidth, behavior: 'smooth' }); });
      prevBtn.addEventListener('click', (e) => { e.preventDefault(); e.stopPropagation(); const cur = Math.round(track.scrollLeft / track.offsetWidth); track.scrollTo({ left: cur <= 0 ? track.offsetWidth * (total - 1) : track.scrollLeft - track.offsetWidth, behavior: 'smooth' }); });
      track.addEventListener('scroll', updateUI);
    });

    // 購物車按鈕初始化
    document.querySelectorAll('.cart-icon').forEach(btn => {
      const card = btn.closest('.haku-card');
      if (!card || btn.hasAttribute('data-init')) return;
      btn.setAttribute('data-init', 'true');
      btn.addEventListener('click', (e) => {
        e.preventDefault(); e.stopPropagation(); // 再次確保不冒泡
        const jsonStr = card.getAttribute('data-json');
        if (jsonStr) { try { addToCart(JSON.parse(jsonStr)); } catch(e){} }
      });
    });
  }
  document.addEventListener('astro:page-load', initInteractive);
  initInteractive();
</script>
