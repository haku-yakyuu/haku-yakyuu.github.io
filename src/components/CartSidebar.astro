---
---
<div id="cart-overlay" class="overlay"></div>

<aside id="cart-sidebar" class="cart-sidebar">
  <div class="cart-header">
    <div class="cart-title">您的購物車</div>
    <span id="close-cart" class="material-symbols-outlined close-cart">close</span>
  </div>
  
  <div class="cart-items" id="cart-items-container">
    </div>
  
  <div class="cart-footer">
    <div class="cart-total">
      <span class="total-label">總計 (TWD)</span>
      <span class="total-price" id="cart-total">$ 0</span>
    </div>
    <a href="/contact-success?from=cart" target="_blank" class="checkout-btn">
      <span class="material-symbols-outlined" style="font-size: 20px;">chat</span>
      透過 LINE 訂購
    </a>
  </div>
</aside>

<script>
  import { isCartOpen, cartItems, removeFromCart, updateQuantity } from '../store';

  const sidebar = document.getElementById('cart-sidebar');
  const overlay = document.getElementById('cart-overlay');
  const closeBtn = document.getElementById('close-cart');
  const container = document.getElementById('cart-items-container');
  const totalEl = document.getElementById('cart-total');
  const titleEl = document.querySelector('.cart-title');

  // 開關邏輯
  isCartOpen.subscribe(open => {
    if (open) {
      sidebar?.classList.add('open');
      overlay?.classList.add('open');
    } else {
      sidebar?.classList.remove('open');
      overlay?.classList.remove('open');
    }
  });

  const close = () => isCartOpen.set(false);
  closeBtn?.addEventListener('click', close);
  overlay?.addEventListener('click', close);

  // 渲染購物車
  cartItems.subscribe(items => {
    if (!container || !totalEl || !titleEl) return;
    
    // 更新標題
    titleEl.textContent = `您的購物車 (${items.length})`;

    // 計算總額
    const total = items.reduce((sum, item) => sum + item.price * item.quantity, 0);
    totalEl.textContent = new Intl.NumberFormat('zh-TW', { style: 'currency', currency: 'TWD', maximumFractionDigits: 0 }).format(total);

    if (items.length === 0) {
      container.innerHTML = '<p class="empty-msg">購物車是空的</p>';
      return;
    }

    container.innerHTML = '';

    items.forEach(item => {
      const el = document.createElement('div');
      el.className = 'cart-item';
      
      let hasImage = item.image && item.image !== "no_image";
      let imgContent = hasImage ? `<img src="${item.image}" alt="${item.name}">` : `<span class="material-symbols-outlined">shopping_bag</span>`;

      const formattedPrice = new Intl.NumberFormat('zh-TW', { style: 'currency', currency: 'TWD', maximumFractionDigits: 0 }).format(item.price);

      // 動態加入 class: has-image 或 no-image
      el.innerHTML = `
        <div class="item-thumb-box ${hasImage ? 'has-image' : 'no-image'}">
          ${imgContent}
        </div>
        <div class="item-info">
          
          <div class="info-top">
            <div class="item-title">${item.name}</div>
            <div class="item-price">${formattedPrice}</div>
          </div>

          <div class="info-bottom">
            <div class="qty-control">
              <div class="qty-btn minus">−</div>
              <div class="qty-val">${item.quantity}</div>
              <div class="qty-btn plus">+</div>
            </div>
            
            <div class="remove-box">
              <span class="material-symbols-outlined">close</span>
            </div>
          </div>
        </div>
      `;

      // 綁定事件
      el.querySelector('.minus')?.addEventListener('click', () => updateQuantity(item.id, item.quantity - 1));
      el.querySelector('.plus')?.addEventListener('click', () => updateQuantity(item.id, item.quantity + 1));
      el.querySelector('.remove-box')?.addEventListener('click', () => removeFromCart(item.id));

      container.appendChild(el);
    });
  });
</script>

<style is:global>
  /* 全域樣式設定 */
  .overlay {
    position: fixed; top: 0; left: 0; width: 100%; height: 100%;
    background: rgba(62, 39, 35, 0.4); z-index: 2999;
    opacity: 0; pointer-events: none; transition: opacity 0.4s;
    backdrop-filter: blur(2px);
  }
  .overlay.open { opacity: 1; pointer-events: auto; visibility: visible; }

  .cart-sidebar {
    position: fixed; top: 0; right: -400px;
    width: 380px; max-width: 90%; height: 100vh;
    background-color: #F5F1E8;
    border-left: 1px solid #3E2723;
    box-shadow: -10px 0 30px rgba(0,0,0,0.05);
    z-index: 3000;
    transition: transform 0.4s cubic-bezier(0.16, 1, 0.3, 1);
    display: flex; flex-direction: column;
  }
  .cart-sidebar.open { transform: translateX(-400px); }

  .cart-header {
    padding: 25px 20px; border-bottom: 1px solid #3E2723;
    display: flex; justify-content: space-between; align-items: center;
  }
  .cart-title { font-family: 'Noto Sans TC', 'Montserrat', sans-serif; font-weight: 900; letter-spacing: 1px; font-size: 1.2rem; }
  .close-cart { cursor: pointer; font-size: 1.5rem; color: #3E2723; }

  .cart-items { flex-grow: 1; padding: 20px; overflow-y: auto; }
  .empty-msg { text-align: center; opacity: 0.5; margin-top: 50px; }

  /* --- 商品卡片 --- */
  .cart-item { 
    display: flex; align-items: center; gap: 15px; 
    margin-bottom: 25px; padding-bottom: 20px;
    border-bottom: 1px solid rgba(62,39,35,0.08);
  }
  .cart-item:last-child { border-bottom: none; }

  /* 圖片區塊：
     無圖時 (no-image) -> 顯示溫暖的淡色背景與 Icon
     有圖時 (has-image) -> 背景透明，確保只顯示圖片
  */
  .item-thumb-box {
    width: 90px; height: 90px; flex-shrink: 0;
    overflow: hidden;
    display: flex; justify-content: center; align-items: center;
    /* 這裡只給一個預設邊框，背景色由下面的子類別決定 */
    border: 1px solid rgba(62,39,35,0.1); 
  }
  
  .item-thumb-box.no-image {
    /* 使用極淡的 Ink 色，呈現溫暖的米灰色調，而非死灰 */
    background-color: rgba(62, 39, 35, 0.05); 
  }
  
  .item-thumb-box.has-image {
    background-color: transparent; 
  }

  .item-thumb-box img { width: 100%; height: 100%; object-fit: cover; }
  .item-thumb-box .material-symbols-outlined { color: rgba(62, 39, 35, 0.3); font-size: 32px; }

  /* 文字區塊 */
  .item-info {
    flex-grow: 1; display: flex; flex-direction: column; 
    justify-content: space-between; height: 90px; padding: 2px 0;
  }

  .info-top { display: flex; justify-content: space-between; align-items: flex-start; gap: 10px; }
  .item-title { font-size: 0.95rem; font-weight: 700; line-height: 1.4; color: #3E2723; }
  .item-price { font-family: 'Montserrat', sans-serif; font-size: 1rem; font-weight: 900; white-space: nowrap; color: #3E2723; }

  .info-bottom { display: flex; align-items: center; justify-content: flex-end; gap: 10px; }

  /* 控制器 & 按鈕 */
  .qty-control { display: flex; align-items: center; border: 1px solid #3E2723; height: 32px; }
  .qty-btn {
    width: 32px; height: 100%; display: flex; justify-content: center; align-items: center;
    cursor: pointer; user-select: none; font-size: 1.2rem; color: #3E2723; transition: background 0.2s;
  }
  .qty-btn:hover { background: rgba(62,39,35,0.05); }
  .qty-val {
    width: 40px; height: 100%; display: flex; justify-content: center; align-items: center;
    font-family: 'Montserrat', sans-serif; font-weight: 700; font-size: 0.9rem;
    border-left: 1px solid #3E2723; border-right: 1px solid #3E2723; color: #3E2723;
  }

  .remove-box {
    width: 32px; height: 32px; border: 1px solid #3E2723;
    display: flex; justify-content: center; align-items: center;
    cursor: pointer; transition: 0.2s; color: #3E2723;
  }
  .remove-box:hover { background: #3E2723; color: #F5F1E8; }
  .remove-box .material-symbols-outlined { font-size: 18px; }

  /* Footer */
  .cart-footer { padding: 25px 20px; border-top: 1px solid #3E2723; background-color: #F5F1E8; }
  .cart-total { display: flex; justify-content: space-between; font-weight: 700; margin-bottom: 20px; align-items: baseline; }
  .total-label { font-size: 0.9rem; letter-spacing: 1px; color: #3E2723; }
  .total-price { font-family: 'Montserrat', sans-serif; font-size: 1.5rem; font-weight: 900; color: #3E2723; }
  
  .checkout-btn {
    width: 100%; background: #3E2723; color: #F5F1E8;
    border: none; padding: 18px; font-family: 'Noto Sans TC', sans-serif; font-weight: 700;
    cursor: pointer; letter-spacing: 2px; text-decoration: none;
    transition: 0.3s;
    display: flex; align-items: center; justify-content: center; gap: 8px;
  }
  .checkout-btn:hover { background: #5D4037; letter-spacing: 3px; }
</style>
