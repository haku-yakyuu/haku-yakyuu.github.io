---
// src/components/Sidebar.astro
import { fetchProducts } from '../utils/api';

// 抓取分類資料
const { products } = await fetchProducts();
const categories = [...new Set(products.map((p: any) => p.category))];
---

<aside id="sidebar-menu" class="sidebar">
  <div class="sidebar-header">
    <div class="logo">MENU</div>
    <span class="material-symbols-outlined close-btn" id="close-menu">close</span>
  </div>
  
  <div class="sidebar-content">
    <ul class="menu-list">
      <li><a href="/shop">ALL PRODUCTS <span>所有選品</span></a></li>
      {categories.map((cat: unknown) => (
        <li>
          <a href={`/shop?category=${cat}`}>{String(cat)}</a>
        </li>
      ))}
    </ul>

    <div class="menu-footer">
       <a href="/about">關於我們</a>
       <a href="/policy">運送政策</a>
    </div>
  </div>
</aside>

<div id="overlay-menu" class="overlay"></div>

<style>
  :root { --haku-ink: #3E2723; --haku-paper: #F5F1E8; }
  
  .sidebar {
    position: fixed; top: 0; left: 0; bottom: 0; width: 300px;
    background: var(--haku-paper); color: var(--haku-ink);
    z-index: 2000; transform: translateX(-100%); transition: transform 0.4s cubic-bezier(0.16, 1, 0.3, 1);
    display: flex; flex-direction: column; border-right: 1px solid rgba(62,39,35,0.1);
  }
  .sidebar.open { transform: translateX(0); }
  
  .sidebar-header { padding: 20px; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid rgba(62,39,35,0.1); }
  .logo { font-family: 'Montserrat', sans-serif; font-weight: 900; font-size: 1.2rem; }
  .close-btn { cursor: pointer; }

  .sidebar-content { padding: 40px 20px; flex-grow: 1; display: flex; flex-direction: column; }
  .menu-list { list-style: none; padding: 0; }
  .menu-list li { margin-bottom: 20px; }
  .menu-list a { font-family: 'Montserrat', sans-serif; font-weight: 700; font-size: 1.1rem; display: block; text-decoration: none; color: var(--haku-ink); }
  .menu-list a span { font-family: 'Noto Sans TC'; font-weight: 400; font-size: 0.8rem; margin-left: 10px; opacity: 0.6; }
  
  .menu-footer { margin-top: auto; border-top: 1px solid rgba(62,39,35,0.1); padding-top: 20px; display: flex; flex-direction: column; gap: 10px; }
  .menu-footer a { font-size: 0.9rem; opacity: 0.7; }

  .overlay {
    position: fixed; top: 0; left: 0; right: 0; bottom: 0;
    background: rgba(62,39,35,0.4); backdrop-filter: blur(2px);
    z-index: 1500; opacity: 0; pointer-events: none; transition: opacity 0.4s;
  }
  .overlay.active { opacity: 1; pointer-events: auto; }
</style>

<script>
  import { isMenuOpen } from '../store';

  const sidebar = document.getElementById('sidebar-menu');
  const overlay = document.getElementById('overlay-menu');
  const closeBtn = document.getElementById('close-menu');

  // 訂閱狀態改變 UI
  isMenuOpen.subscribe(isOpen => {
    if (isOpen) {
      sidebar?.classList.add('open');
      overlay?.classList.add('active');
    } else {
      sidebar?.classList.remove('open');
      overlay?.classList.remove('active');
    }
  });

  // 關閉事件
  closeBtn?.addEventListener('click', () => isMenuOpen.set(false));
  overlay?.addEventListener('click', () => isMenuOpen.set(false));
</script>
