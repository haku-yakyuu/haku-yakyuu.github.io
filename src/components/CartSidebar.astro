---
---
<div id="cart-overlay" class="overlay"></div>

<aside id="cart-sidebar" class="cart-sidebar">
  <div class="cart-header">
    <h2>SHOPPING CART</h2>
    <button id="close-cart" class="close-btn material-symbols-outlined">close</button>
  </div>
  
  <div class="cart-items" id="cart-items-container">
    </div>
  
  <div class="cart-footer">
    <div class="total-row">
      <span>TOTAL</span>
      <span id="cart-total">$0</span>
    </div>
    <a href="https://lin.ee/你的LineID" target="_blank" class="checkout-btn">
      前往 LINE 結帳
    </a>
  </div>
</aside>

<script>
  import { isCartOpen, cartItems, removeFromCart, updateQuantity } from '../store';

  const sidebar = document.getElementById('cart-sidebar');
  const overlay = document.getElementById('cart-overlay');
  const closeBtn = document.getElementById('close-cart');
  const container = document.getElementById('cart-items-container');
  const totalEl = document.getElementById('cart-total');

  // 1. 開關側邊欄邏輯
  isCartOpen.subscribe(open => {
    if (open) {
      sidebar?.classList.add('active');
      overlay?.classList.add('active');
    } else {
      sidebar?.classList.remove('active');
      overlay?.classList.remove('active');
    }
  });

  const close = () => isCartOpen.set(false);
  closeBtn?.addEventListener('click', close);
  overlay?.addEventListener('click', close);

  // 2. 渲染購物車邏輯
  cartItems.subscribe(items => {
    if (!container || !totalEl) return;
    
    // 計算總金額
    const total = items.reduce((sum, item) => sum + item.price * item.quantity, 0);
    totalEl.textContent = new Intl.NumberFormat('zh-TW', { style: 'currency', currency: 'TWD', maximumFractionDigits: 0 }).format(total);

    if (items.length === 0) {
      container.innerHTML = '<p class="empty-msg">購物車是空的</p>';
      return;
    }

    container.innerHTML = '';
    
    items.forEach(item => {
      const el = document.createElement('div');
      el.className = 'cart-item';
      
      // --- 圖片邏輯處理 (與 ProductCard 一致) ---
      let imgHtml = '';
      const rawImages = item.layout_images || item.images || "";
      
      if (rawImages) {
        const firstRaw = rawImages.split(',')[0].trim();
        if (firstRaw) {
          // 判斷是否需要補上開頭斜線
          let imgSrc = firstRaw;
          if (!imgSrc.startsWith('http') && !imgSrc.startsWith('/')) {
            imgSrc = '/' + imgSrc;
          }
          imgHtml = `<div class="item-img"><img src="${imgSrc}" alt="${item.name}"></div>`;
        }
      }

      el.innerHTML = `
        ${imgHtml}
        <div class="item-info">
          
          <div class="info-top">
            <span class="item-name">${item.name}</span>
            <span class="item-price">$${item.price}</span>
          </div>

          <div class="info-bottom">
            <div class="qty-control">
              <button class="qty-btn minus">-</button>
              <span class="qty-num">${item.quantity}</span>
              <button class="qty-btn plus">+</button>
            </div>
            
            <button class="remove-btn material-symbols-outlined">close</button>
          </div>

        </div>
      `;

      // 綁定按鈕事件
      el.querySelector('.minus')?.addEventListener('click', () => updateQuantity(item.id, item.quantity - 1));
      el.querySelector('.plus')?.addEventListener('click', () => updateQuantity(item.id, item.quantity + 1));
      el.querySelector('.remove-btn')?.addEventListener('click', () => removeFromCart(item.id));

      container.appendChild(el);
    });
  });
</script>

<style>
  /* 遮罩與側邊欄基礎設定 */
  .overlay {
    position: fixed; top: 0; left: 0; width: 100%; height: 100%;
    background: rgba(0,0,0,0.5); z-index: 2999;
    opacity: 0; visibility: hidden; transition: 0.3s;
  }
  .overlay.active { opacity: 1; visibility: visible; }

  .cart-sidebar {
    position: fixed; top: 0; right: -350px; width: 350px; max-width: 90%; height: 100%;
    background: #F5F1E8; border-left: 1px solid #3E2723;
    z-index: 3000; transition: transform 0.3s ease;
    box-shadow: -2px 0 10px rgba(0,0,0,0.1);
    display: flex; flex-direction: column;
  }
  .cart-sidebar.active { transform: translateX(-350px); }

  .cart-header {
    padding: 20px; border-bottom: 1px solid rgba(62,39,35,0.1);
    display: flex; justify-content: space-between; align-items: center; background: #F5F1E8;
  }
  .cart-header h2 { margin: 0; font-size: 1.2rem; font-family: 'Montserrat', sans-serif; font-weight: 900; }
  .close-btn { background: none; border: none; cursor: pointer; font-size: 1.5rem; color: #3E2723; }

  .cart-items { flex-grow: 1; overflow-y: auto; padding: 20px; }
  .empty-msg { text-align: center; opacity: 0.5; margin-top: 40px; }

  /* --- 購物車項目 (Flex 佈局) --- */
  .cart-item { 
    display: flex; 
    gap: 15px; 
    margin-bottom: 25px; 
    align-items: center; /* 讓左圖與右文垂直置中 */
    border-bottom: 1px solid rgba(62,39,35,0.1); 
    padding-bottom: 25px; 
  }
  .cart-item:last-child { border-bottom: none; }
  
  /* 左側圖片區 (關鍵：flex-shrink: 0 防止被擠壓) */
  .item-img { 
    width: 80px; 
    height: 80px; 
    flex-shrink: 0; 
    background: #DCD7CE; 
    border: 1px solid rgba(62,39,35,0.1);
  }
  .item-img img { width: 100%; height: 100%; object-fit: cover; }
  
  /* 右側文字區 */
  .item-info { 
    flex-grow: 1; 
    display: flex; 
    flex-direction: column; 
    gap: 12px; /* 上下區塊間距 */
  }
  
  /* 上半部：品名與價格 */
  .info-top { 
    display: flex; 
    justify-content: space-between; 
    align-items: flex-start; 
    gap: 10px; 
  }
  .item-name { 
    font-size: 0.9rem; 
    font-weight: 700; 
    line-height: 1.3; 
    color: #3E2723;
  }
  .item-price { 
    font-family: 'Montserrat', sans-serif; 
    font-weight: 700; 
    font-size: 1rem; 
    white-space: nowrap;
  }
  
  /* 下半部：控制器與移除鈕 */
  .info-bottom { 
    display: flex; 
    align-items: center; 
    gap: 10px; /* 控制器與移除鈕的間距 */
  }
  
  /* --- 數量控制器 (框框設計) --- */
  .qty-control { 
    display: flex; 
    align-items: center; 
    border: 1px solid #3E2723; /* 實線框 */
    height: 32px;
  }
  .qty-btn { 
    background: none; 
    border: none; 
    width: 32px; 
    height: 100%; 
    cursor: pointer; 
    color: #3E2723; 
    font-size: 1.2rem;
    display: flex; align-items: center; justify-content: center;
    transition: background 0.2s;
  }
  .qty-btn:hover { background: rgba(62,39,35,0.1); }
  .qty-num { 
    width: 32px; 
    text-align: center; 
    font-size: 0.9rem; 
    font-family: 'Montserrat', sans-serif; 
    font-weight: 700;
  }

  /* --- 移除按鈕 (框框設計) --- */
  .remove-btn { 
    background: none; 
    border: 1px solid #3E2723; /* 實線框 */
    height: 32px;
    width: 32px;
    cursor: pointer; 
    color: #3E2723; 
    font-size: 1.2rem; 
    display: flex; 
    align-items: center; 
    justify-content: center;
    transition: all 0.2s;
  }
  .remove-btn:hover { 
    background: #3E2723; 
    color: #F5F1E8; 
  }

  /* Footer */
  .cart-footer { padding: 20px; border-top: 1px solid rgba(62,39,35,0.1); background: #F5F1E8; }
  .total-row { display: flex; justify-content: space-between; font-family: 'Montserrat', sans-serif; font-weight: 900; font-size: 1.2rem; margin-bottom: 15px; }
  .checkout-btn { display: block; width: 100%; padding: 12px; background: #3E2723; color: #F5F1E8; text-align: center; text-decoration: none; font-weight: 700; transition: 0.3s; }
  .checkout-btn:hover { opacity: 0.9; }
</style>
