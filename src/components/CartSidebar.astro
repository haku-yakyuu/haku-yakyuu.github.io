---
---
<div id="cart-overlay" class="overlay"></div>

<aside id="cart-sidebar" class="cart-sidebar">
  <div class="cart-header">
    <h2>SHOPPING CART</h2>
    <button id="close-cart" class="close-btn material-symbols-outlined">close</button>
  </div>
  
  <div class="cart-items" id="cart-items-container">
    </div>
  
  <div class="cart-footer">
    <div class="total-row">
      <span>TOTAL</span>
      <span id="cart-total">$0</span>
    </div>
    <a href="https://lin.ee/你的LineID" target="_blank" class="checkout-btn">
      前往 LINE 結帳
    </a>
  </div>
</aside>

<script>
  import { isCartOpen, cartItems, removeFromCart, updateQuantity } from '../store';

  const sidebar = document.getElementById('cart-sidebar');
  const overlay = document.getElementById('cart-overlay');
  const closeBtn = document.getElementById('close-cart');
  const container = document.getElementById('cart-items-container');
  const totalEl = document.getElementById('cart-total');

  // 開關邏輯
  isCartOpen.subscribe(open => {
    if (open) {
      sidebar?.classList.add('active');
      overlay?.classList.add('active');
    } else {
      sidebar?.classList.remove('active');
      overlay?.classList.remove('active');
    }
  });

  const close = () => isCartOpen.set(false);
  closeBtn?.addEventListener('click', close);
  overlay?.addEventListener('click', close);

  // 渲染購物車 (依據新需求：左圖右文、上下置中)
  cartItems.subscribe(items => {
    if (!container || !totalEl) return;
    
    // 計算總額
    const total = items.reduce((sum, item) => sum + item.price * item.quantity, 0);
    totalEl.textContent = new Intl.NumberFormat('zh-TW', { style: 'currency', currency: 'TWD', maximumFractionDigits: 0 }).format(total);

    if (items.length === 0) {
      container.innerHTML = '<p class="empty-msg">購物車是空的</p>';
      return;
    }

    container.innerHTML = '';
    items.forEach(item => {
      const el = document.createElement('div');
      el.className = 'cart-item';
      
      // 處理圖片
      let imgHtml = '';
      if (item.images || item.layout_images) {
        const raw = item.layout_images || item.images;
        const firstImg = raw.split(',')[0].trim();
        // 修正路徑
        const imgSrc = (firstImg.startsWith('http') || firstImg.startsWith('/')) ? firstImg : '/' + firstImg;
        if(imgSrc) {
           imgHtml = `<div class="item-img"><img src="${imgSrc}" alt="${item.name}"></div>`;
        }
      }

      el.innerHTML = `
        ${imgHtml}
        <div class="item-info">
          <div class="info-top">
            <span class="item-name">${item.name}</span>
            <span class="item-price">$${item.price}</span>
          </div>
          <div class="info-bottom">
            <div class="qty-control">
              <button class="qty-btn minus">-</button>
              <span class="qty-num">${item.quantity}</span>
              <button class="qty-btn plus">+</button>
            </div>
            <button class="remove-btn material-symbols-outlined">close</button>
          </div>
        </div>
      `;

      // 綁定事件
      el.querySelector('.minus')?.addEventListener('click', () => updateQuantity(item.id, item.quantity - 1));
      el.querySelector('.plus')?.addEventListener('click', () => updateQuantity(item.id, item.quantity + 1));
      el.querySelector('.remove-btn')?.addEventListener('click', () => removeFromCart(item.id));

      container.appendChild(el);
    });
  });
</script>

<style>
  .overlay {
    position: fixed; top: 0; left: 0; width: 100%; height: 100%;
    background: rgba(0,0,0,0.5); z-index: 2999;
    opacity: 0; visibility: hidden; transition: 0.3s;
  }
  .overlay.active { opacity: 1; visibility: visible; }

  .cart-sidebar {
    position: fixed; top: 0; right: -350px; width: 350px; max-width: 90%; height: 100%;
    background: #F5F1E8; border-left: 1px solid #3E2723;
    z-index: 3000; transition: transform 0.3s ease;
    box-shadow: -2px 0 10px rgba(0,0,0,0.1);
    display: flex; flex-direction: column;
  }
  .cart-sidebar.active { transform: translateX(-350px); }

  .cart-header {
    padding: 20px; border-bottom: 1px solid rgba(62,39,35,0.1);
    display: flex; justify-content: space-between; align-items: center; background: #F5F1E8;
  }
  .cart-header h2 { margin: 0; font-size: 1.2rem; font-family: 'Montserrat', sans-serif; }
  .close-btn { background: none; border: none; cursor: pointer; font-size: 1.5rem; color: #3E2723; }

  .cart-items { flex-grow: 1; overflow-y: auto; padding: 20px; }
  .empty-msg { text-align: center; opacity: 0.5; margin-top: 40px; }

  /* --- 購物車項目樣式 (左圖右文) --- */
  .cart-item { display: flex; gap: 15px; margin-bottom: 20px; align-items: center; border-bottom: 1px solid rgba(62,39,35,0.05); padding-bottom: 20px; }
  
  .item-img { width: 70px; height: 70px; flex-shrink: 0; background: #DCD7CE; border-radius: 4px; overflow: hidden; }
  .item-img img { width: 100%; height: 100%; object-fit: cover; }
  
  .item-info { flex-grow: 1; display: flex; flex-direction: column; gap: 8px; justify-content: center; }
  
  .info-top { display: flex; justify-content: space-between; align-items: flex-start; gap: 10px; }
  .item-name { font-size: 0.95rem; font-weight: 700; line-height: 1.3; }
  .item-price { font-family: 'Montserrat', sans-serif; font-weight: 700; font-size: 1rem; }
  
  .info-bottom { display: flex; justify-content: space-between; align-items: center; }
  
  .qty-control { display: flex; align-items: center; border: 1px solid #3E2723; border-radius: 4px; overflow: hidden; }
  .qty-btn { background: none; border: none; width: 24px; height: 24px; cursor: pointer; color: #3E2723; display: flex; align-items: center; justify-content: center; font-size: 1.2rem; }
  .qty-btn:hover { background: rgba(62,39,35,0.1); }
  .qty-num { width: 24px; text-align: center; font-size: 0.9rem; font-family: 'Montserrat', sans-serif; }
  
  .remove-btn { background: none; border: none; cursor: pointer; color: #D32F2F; font-size: 1.2rem; display: flex; align-items: center; }

  /* Footer */
  .cart-footer { padding: 20px; border-top: 1px solid rgba(62,39,35,0.1); background: #F5F1E8; }
  .total-row { display: flex; justify-content: space-between; font-family: 'Montserrat', sans-serif; font-weight: 900; font-size: 1.2rem; margin-bottom: 15px; }
  .checkout-btn { display: block; width: 100%; padding: 12px; background: #3E2723; color: #F5F1E8; text-align: center; text-decoration: none; font-weight: 700; transition: 0.3s; }
  .checkout-btn:hover { opacity: 0.9; }
</style>
