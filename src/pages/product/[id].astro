---
import Layout from '../../layouts/Layout.astro';
import { fetchProducts } from '../../utils/api';

// 1. 生成所有商品的靜態路徑
export async function getStaticPaths() {
  const { products } = await fetchProducts();
  return products.map((p) => ({
    params: { id: p.id },
    props: { product: p },
  }));
}

const { product } = Astro.props;
const { config } = await fetchProducts(); // 取得設定檔以獲取 site_title

// --- 圖片處理邏輯 ---
const rawImages = product.layout_images || product.images || "";
const imagesArr = rawImages.split(',')
  .map((url: string) => {
    let cleanUrl = url.trim();
    if (!cleanUrl) return null;
    if (cleanUrl.startsWith('http')) return cleanUrl;
    if (!cleanUrl.startsWith('/')) return '/' + cleanUrl;
    return cleanUrl;
  })
  .filter(Boolean);

// 如果沒有圖片，給一個預設值
const hasImages = imagesArr.length > 0;
const mainImage = hasImages ? imagesArr[0] : null;

// 價格格式化
const priceStr = new Intl.NumberFormat('zh-TW', { style: 'currency', currency: 'TWD', maximumFractionDigits: 0 }).format(product.price);

// 頁面標題
const pageTitle = `${product.name} | ${config?.site_title || 'HAKU'}`;

// 序列化商品資料給 JS 使用
const productJson = JSON.stringify({
  id: product.id,
  name: product.name,
  price: product.price,
  // 這裡傳第一張圖給購物車顯示
  layout: hasImages ? imagesArr[0] : 'no_image' 
});
---

<Layout title={pageTitle}>
  <main class="container product-detail">
    
    <div class="detail-grid">
      
      {/* --- 左側：圖片區域 --- */}
      <div class="gallery-section">
        {/* 主圖 */}
        <div class="main-image-box">
          {hasImages ? (
            <img id="main-img" src={mainImage} alt={product.name} />
          ) : (
            <div class="no-image-placeholder">
              <span class="material-symbols-outlined">shopping_bag</span>
              <p>NO IMAGE</p>
            </div>
          )}
        </div>

        {/* 縮圖列表 (多張圖才顯示) */}
        {imagesArr.length > 1 && (
          <div class="thumb-list">
            {imagesArr.map((img: string, index: number) => (
              <div class={`thumb-item ${index === 0 ? 'active' : ''}`} data-src={img}>
                <img src={img} alt={`thumb-${index}`} />
              </div>
            ))}
          </div>
        )}
      </div>

      {/* --- 右側：資訊區域 --- */}
      <div class="info-section">
        
        {/* 標頭資訊 */}
        <div class="info-header">
          <div class="badges">
            {product.isFeatured && <span class="badge">精選</span>}
            <span class="product-code">{product.id.toUpperCase()}</span>
          </div>
          <h1 class="product-title">{product.name}</h1>
          <div class="product-price">{priceStr}</div>
        </div>

        {/* 商品描述 (desc) */}
        <div class="product-desc">
          <p>{product.desc || "暫無商品說明。"}</p>
        </div>

        {/* 數量控制 */}
        <div class="action-area">
          <label class="qty-label">數量 (庫存: <span id="stock-display">{product.stock || 99}</span>)</label>
          <div class="qty-control-lg">
            <button id="qty-minus" class="qty-btn">−</button>
            <span id="qty-val" class="qty-val">1</span>
            <button id="qty-plus" class="qty-btn">+</button>
          </div>
        </div>

        {/* 按鈕組 */}
        <div class="btn-group">
          <button id="add-to-cart-btn" class="btn-primary" data-json={productJson}>
            加入購物車
          </button>
          <a href="https://lin.ee/xeHmvkN" target="_blank" class="btn-outline">
            <span class="material-symbols-outlined">chat</span>
            透過 LINE 查詢
          </a>
        </div>

      </div>
    </div>
  </main>
</Layout>

<script>
  import { addToCart } from '../../store';

  document.addEventListener('astro:page-load', () => {
    const mainImg = document.getElementById('main-img') as HTMLImageElement;
    const thumbs = document.querySelectorAll('.thumb-item');
    const qtyValEl = document.getElementById('qty-val');
    const stockEl = document.getElementById('stock-display');
    const addBtn = document.getElementById('add-to-cart-btn');
    const minusBtn = document.getElementById('qty-minus');
    const plusBtn = document.getElementById('qty-plus');

    let currentQty = 1;
    const maxStock = stockEl ? parseInt(stockEl.innerText) : 99;

    // 1. 圖片切換邏輯
    thumbs.forEach(thumb => {
      thumb.addEventListener('click', () => {
        // 移除所有 active
        thumbs.forEach(t => t.classList.remove('active'));
        // 自己加上 active
        thumb.classList.add('active');
        // 切換大圖
        const src = thumb.getAttribute('data-src');
        if (mainImg && src) mainImg.src = src;
      });
    });

    // 2. 數量控制邏輯
    const updateQtyDisplay = () => {
      if(qtyValEl) qtyValEl.innerText = currentQty.toString();
    };

    minusBtn?.addEventListener('click', () => {
      if (currentQty > 1) {
        currentQty--;
        updateQtyDisplay();
      }
    });

    plusBtn?.addEventListener('click', () => {
      if (currentQty < maxStock) {
        currentQty++;
        updateQtyDisplay();
      }
    });

    // 3. 加入購物車邏輯
    addBtn?.addEventListener('click', () => {
      const jsonStr = addBtn.getAttribute('data-json');
      if (jsonStr) {
        try {
          const productData = JSON.parse(jsonStr);
          // 將當前選擇的數量一併帶入
          // 注意：store 的 addToCart 目前預設+1，我們需要稍微修改 store 支援數量，
          // 但為了不改動 store，我們這裡迴圈呼叫 (簡單暴力) 或直接修改 store。
          // 這裡採用簡單策略：直接加入 N 次 (因為 store 邏輯是 += 1)
          // *更好的做法是修改 store.js 的 addToCart 支援 quantity 參數，但先維持現狀*
          
          // 暫時解法：連續加入 (雖然笨但有效，不會破壞現有架構)
          for(let i=0; i<currentQty; i++) {
             addToCart(productData);
          }
          
          // 按鈕回饋
          const originalText = addBtn.innerText;
          addBtn.innerText = "已加入！";
          addBtn.style.background = "#5D4037";
          setTimeout(() => {
            addBtn.innerText = originalText;
            addBtn.style.background = "";
          }, 1000);

        } catch(e) { console.error(e); }
      }
    });
  });
</script>

<style>
  /* 容器設定 */
  .product-detail { padding-top: 60px; padding-bottom: 100px; }
  
  .detail-grid {
    display: grid; grid-template-columns: 1fr; gap: 40px;
  }
  
  /* 電腦版分兩欄 */
  @media (min-width: 1024px) {
    .detail-grid { grid-template-columns: 1fr 1fr; gap: 60px; align-items: start; }
  }

  /* --- 左側圖片 --- */
  .main-image-box {
    width: 100%; aspect-ratio: 1/1;
    background: #DCD7CE;
    display: flex; justify-content: center; align-items: center;
    overflow: hidden; margin-bottom: 20px;
    border: 1px solid rgba(62,39,35,0.1);
  }
  .main-image-box img { width: 100%; height: 100%; object-fit: cover; transition: opacity 0.3s; }
  
  .no-image-placeholder { display: flex; flex-direction: column; align-items: center; color: rgba(62,39,35,0.3); font-weight: 700; }
  .no-image-placeholder span { font-size: 48px; margin-bottom: 10px; }

  /* 縮圖列 */
  .thumb-list { display: flex; gap: 15px; overflow-x: auto; padding-bottom: 10px; }
  .thumb-item {
    width: 80px; height: 80px; flex-shrink: 0;
    border: 1px solid transparent; cursor: pointer;
    opacity: 0.6; transition: 0.2s;
  }
  .thumb-item img { width: 100%; height: 100%; object-fit: cover; }
  .thumb-item:hover { opacity: 1; }
  .thumb-item.active { border-color: var(--haku-ink); opacity: 1; }

  /* --- 右側資訊 --- */
  .badges { display: flex; align-items: center; gap: 10px; margin-bottom: 15px; }
  .badge {
    padding: 4px 12px; font-size: 0.75rem; font-weight: 700;
    border: 1px solid var(--haku-ink); letter-spacing: 1px;
  }
  .product-code { font-family: 'Montserrat', sans-serif; font-size: 0.8rem; letter-spacing: 1px; opacity: 0.5; }

  .product-title { font-size: 1.8rem; font-weight: 700; margin: 0 0 10px 0; line-height: 1.3; }
  .product-price { font-family: 'Montserrat', sans-serif; font-size: 1.5rem; font-weight: 900; margin-top: 15px; }

  .product-desc {
    margin: 30px 0; padding: 30px 0;
    border-top: 1px solid rgba(62,39,35,0.1);
    border-bottom: 1px solid rgba(62,39,35,0.1);
    line-height: 1.8; color: #5D4037;
    white-space: pre-wrap; /* 保留換行 */
  }

  /* 數量控制區 */
  .action-area { margin-bottom: 30px; }
  .qty-label { display: block; font-size: 0.8rem; font-weight: 700; margin-bottom: 10px; opacity: 0.8; }
  
  .qty-control-lg {
    display: flex; align-items: center;
    border: 1px solid var(--haku-ink);
    width: 140px; height: 48px;
  }
  .qty-btn {
    flex: 1; height: 100%; background: none; border: none;
    font-size: 1.2rem; cursor: pointer; color: var(--haku-ink);
    display: flex; justify-content: center; align-items: center;
    transition: 0.2s;
  }
  .qty-btn:hover { background: rgba(62,39,35,0.05); }
  .qty-val {
    flex: 1; text-align: center; font-family: 'Montserrat', sans-serif; font-weight: 700; font-size: 1.1rem;
  }

  /* 按鈕組 */
  .btn-group { display: flex; flex-direction: column; gap: 15px; }
  
  .btn-primary, .btn-outline {
    width: 100%; padding: 18px; font-weight: 700; letter-spacing: 2px;
    cursor: pointer; transition: 0.3s; text-align: center; text-decoration: none;
    display: flex; align-items: center; justify-content: center; gap: 10px;
    font-size: 1rem;
  }

  .btn-primary {
    background: var(--haku-ink); color: var(--haku-paper); border: none;
  }
  .btn-primary:hover { opacity: 0.9; }

  .btn-outline {
    background: transparent; color: var(--haku-ink); border: 1px solid var(--haku-ink);
  }
  .btn-outline:hover { background: rgba(62,39,35,0.05); }

</style>
